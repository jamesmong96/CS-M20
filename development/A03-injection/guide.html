<html>
    <head>
        <title>A03 - Guide</title>
        <link rel="icon" href="../resources/image/favicon.ico">
        <!-- bootstrap css and js -->
        <link rel="stylesheet" href="../resources/css/bootstrap.min.css">
        <link rel="stylesheet" href="../resources/css/bootstrap.min.css.map">
        <script src="../resources/js/jquery-3.6.0.min.js"></script>
        <script src="../resources/js/bootstrap.min.js"></script>
        <style>
            .custom-scenario.accordion-button {
                color: #141619;
                background-color: #d3d3d4;
                box-shadow: inset 0 calc(var(--bs-accordion-border-width) * -1) 0 var(--bs-accordion-border-color);
            }

            .custom-attack.accordion-button {
                color: #842029;
                background-color: #f8d7da;
                box-shadow: inset 0 calc(var(--bs-accordion-border-width) * -1) 0 var(--bs-accordion-border-color);
            }

            .custom-defense.accordion-button {
                color: #0f5132;
                background-color: #d1e7dd;
                box-shadow: inset 0 calc(var(--bs-accordion-border-width) * -1) 0 var(--bs-accordion-border-color);
            }

            .custom-explanation.accordion-button {
                color: #084298;
                background-color: #cfe2ff;
                box-shadow: inset 0 calc(var(--bs-accordion-border-width) * -1) 0 var(--bs-accordion-border-color);
            }

            .custom-challenge.accordion-button {
                color: #055160;
                background-color: #cff4fc;
                box-shadow: inset 0 calc(var(--bs-accordion-border-width) * -1) 0 var(--bs-accordion-border-color);
            }

            .accordion-button:hover {
                opacity: 75%;
            }
        </style>
    </head>
    <body class="text-center">
        <main class="w-100 m-auto">
            <h1 class="h1 mb-3 mt-3 fw-normal m-auto">A03: Injection</h1>
            <h5 class="h5 mb-5 fw-normal">Please read the following scenario</h5>
            <div class="accordion mx-5" id="accordionExample">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingOne">
                        <button class="accordion-button custom-scenario" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                            Scenario
                        </button>
                    </h2>
                    <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne">
                        <div class="accordion-body text-start m-3">
                            You are the security manager of Random Company. The system administrator have just implemented a login page for all the staffs and an admin page to log recent login attempts. 
                            You want to make sure the pages are secure and protected before launching it into the production environment. 
                            Thus you are going to do some penetration testings on the pages to discover any potential weaknesses.
                            <br><br>
                            Click here to enter the <a href="./login.php" target="_blank">Login Page</a>
                            <br>
                            Click here to enter the <a href="./admin.php" target="_blank">Admin Page</a>
                            <br><br>
                            You can reset the database by visiting this page <strong>(You will delete all the records in the database, think clearly before you reset)</strong>: <a href="./reset.php" target="_blank">Reset</a>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingTwo">
                        <button class="accordion-button custom-attack collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                            Attack
                        </button>
                    </h2>
                    <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo">
                        <div class="accordion-body text-start m-3">
                            Before you start exploiting the console page, please read what is injection.
                            <figure class="text-center m-3">
                                <blockquote class="blockquote">
                                    <p><u>Almost any source of data can be an injection vector, environment variables, parameters, external and internal web services, and all types of users. Injection flaws occur when an attacker can send hostile data to an interpreter.</u></p>
                                </blockquote>
                                <figcaption class="blockquote-footer">
                                    Description in <cite title="Source Title">OWASP Top 10:2017</cite>
                                </figcaption>
                            </figure>
                            There are two vulnerabilities exist in the pages, both of them are related to injection.
                            You can explore the pages by yourself and search for any traces of the weaknesses.
                            <p>
                                <button class="btn btn-primary my-3 me-3" type="button" data-bs-toggle="collapse" data-bs-target="#multiCollapseExample1" aria-expanded="false" aria-controls="multiCollapseExample1">Show hint #1</button>
                                <button class="btn btn-primary my-3 mx-3" type="button" data-bs-toggle="collapse" data-bs-target="#multiCollapseExample2" aria-expanded="false" aria-controls="multiCollapseExample2">Show hint #2</button>
                                <button class="btn btn-primary my-3 ms-3" type="button" data-bs-toggle="collapse" data-bs-target="#multiCollapseExample3" aria-expanded="false" aria-controls="multiCollapseExample3">Show full exploitations</button>
                            </p>
                            <div class="row">
                                <div class="col">
                                    <div class="collapse multi-collapse" id="multiCollapseExample1">
                                        <div class="card card-body">
                                            <h5>Vulnerability #1</h5>
                                            <p>
                                                This category has a new member, cross-site scripting. Trying different tags/cases will be helpful. Don't let the HTML limits you.
                                                <br>
                                                (Some researches online will be very helpful)
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col">
                                        <div class="collapse multi-collapse" id="multiCollapseExample2">
                                        <div class="card card-body">
                                            <h5>Vulnerability #2</h5>
                                            <p>
                                                SQL injection is one of the most popular attacks in this category, it can help you to login successfully. Don't let the HTML limits you.
                                                <br>
                                                (Usually there will be only <u>one</u> matching account in the database)
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col">
                                    <div class="collapse multi-collapse" id="multiCollapseExample3">
                                        <div class="card card-body">
                                            <h5>Vulnerability #1</h5>
                                            <p>
                                                This vulnerability is related to cross-site scripting, which can be exploited in <code>admin.php</code>. 
                                                As we can see that all the login attempts are shown on the table with its username and password, this is a sign of this page is very likely to be vulnerable against cross-site scripting.
                                                If there are no proper input sanitization, a malicious user can leverage the weakness and execute Javascript code on other users' browsers. 
                                                This can lead to serious consequences, including stealing authentication cookies or redirecting to phishing websites. 
                                            </p>
                                            <h6>Exploitation</h6>
                                            <ol>
                                                <li>(The exploitation uses the function <code>console.log()</code> instead of <code>alert()</code> to avoid massive alert boxes popping out, the results can be viewed by pressing <kbd>F12</kbd> and click on the <code>Console</code> tab.)</li>
                                                <li>From <code>login.php</code>, we notice there are two input boxes, which are <code>username</code> and <code>password</code>.</li>
                                                <li>However we also notice that the <code>username</code> input box has a length limitation on input, which is 10 characters.</li>
                                                <li>There are two ways to bypass this limitation:
                                                    <ul>
                                                        <li>Use the <code>password</code> input box to continue the exploitation</li>
                                                        <li>Remove the <code>maxlength</code> attribute from the HTML content</li>
                                                    </ul>
                                                </li>
                                                <li>We first start with the simplest version of payload: <code>&lt;script&gt; console.log("test1"); &lt;/script&gt;</code></li>
                                                <li>You should notice after refreshing <code>admin.php</code>, nothing is printed on the console and you can see <code>&lt;script&gt; console.log("test1");</code> on the login attempts table.</li>
                                                <li>This indicates the page has at least sanitized the term <code>&lt;script&gt;</code> because it is not interpreted as HTML content. Also we found out that <code>&lt;/script&gt;</code> is interpreted as HTML content because it is not visible on the page.</li>
                                                <li>Therefore we can try to alter the payload a bit to evade the sanitization, such as changing the letter case: <code>&lt;SCRIPT&gt; console.log("test2"); &lt;/SCRIPT&gt;</code></li>
                                                <li>Then you see <code>test2</code> is printed on the console and the password field of the latest entry is empty, which means the content is interpreted as pure HTML content.</li>
                                                <li>You can now execute Javascript code on other users' browsers!</li>
                                            </ol>
                                            <h6>Explanation</h6>
                                            <p>
                                                This vulnerability occurs when the page doesn't sanitize the text and the text is treated as part of the HTML content by the browser. 
                                                Modern browsers rely on different tags to interpret the content of a website. 
                                                There are many functional tags, such as <code>&lt;meta&gt;</code> for metadata, <code>&lt;style&gt;</code> for styling of the pages and <code>&lt;script&gt;</code> for executing Javascript. 
                                                When a malicious user entered something with <code>&lt;script&gt;</code>, it is very natural for most of the browsers these days to treat it as Javascript tag and run whatever code in it. 
                                                Changing the letter case of the tag is only one of the methods to bypass sanitization. 
                                                Keep in mind that using the <code>&lt;script&gt;</code> tag is only a very simple demonstration here, there are a lot of tags can trigger cross-site scripting, like <code>&lt;body&gt;</code>, <code>&lt;iframe&gt;</code> and the list goes on.
                                            </p>
                                            <h5>Vulnerability #2</h5>
                                            <p>
                                                This vulnerability is related to SQL injection, which occurs when the page doesn't implement prepared statements. 
                                                Most of the applications using SQL databases have to pay extra attentions to SQL injection. 
                                                The login page is one of the examples which binds the variables and the SQL statement directly without any input validations. 
                                                As a result, if the variables are carefully crafted with SQL syntax, the query statement can be altered and causes unexpected changes to the database.
                                            </p>
                                            <h6>Exploitation</h6>
                                            <ol>
                                                <li>The targets of SQL injection are either the <code>username</code> or <code>password</code> input box.</li>
                                                <li>Similar to Vulnerability #1, find a way to bypass the input limitation first.</li>
                                                <li>Then we can try with the simplest form of SQL injection: <code>' OR 1=1 #</code></li>
                                                <li>We notice the payload fails to login, then we modify it and try to guess some common usernames: <code>admin' #</code> / <code>user' #</code></li>
                                                <li>After several failed attempts, we check the hint #2. It says it is looking for one matching account in the database.</li>
                                                <li>Thus we can try this payload: <code>' OR 1=1 LIMIT 1 #</code></li>
                                                <li>We can login to the page!</li>
                                            </ol>
                                            <h6>Explanation</h6>
                                            <p>
                                                This vulnerability is an example of weak SQL injection prevention measures. 
                                                It can successfully stop the attackers with the simplest version of the attacks, but it is very easy to bypass. 
                                                In SQL syntax, <code>#</code> indicates the start of a comment, which means any words after it will be ignored by the query. 
                                                Therefore in the first payload, the query becomes select all the entries in the database because <code>1=1</code> is always true. 
                                                However the page has a simple detection logic, such that if the returned data has more than 1 row, it is likely that someone is altering the query. 
                                                Thus the keyword <code>LIMIT</code> can help us to evade the detection as it limits the number of row returned. 
                                                By adding the clause <code>LIMIT 1</code>, the query only returns 1 row of data and logged in successfully.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingThree">
                        <button class="accordion-button custom-defense collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                            Defense
                        </button>
                    </h2>
                    <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree">
                        <div class="accordion-body text-start m-3">
                            <p>
                                There are a lot of methods to defense against the above vulnerabilities. 
                                The methods describe in this section may not be the best method, but are able to stop similar attacks. 
                                You are welcome to change the files and test your own defense mechanisms.
                            </p>
                            <h5>Code Explanation</h5>
                            <p>
                                Before you implement the countermeasures, you have to know what the code is doing and which part of the code you should change.
                                Below are the code snippets of the relevant logic, please fully understand the code before you proceed.
                            </p>
                            <h6>admin.php (Vulnerability #1)</h6>
                            <p>
                                This is the file responsible for showing all the login attempts. 
                                Most of the systems actually store all the login attempts to detect any possible traces of attacks, such as brute force attack. 
                                How to store and show the data properly is also an important consideration when implementing an admin page like this. 
                                Remember that all the attack methods and defense mechanisms demonstrated here are only a small portion of the actual real-world scenarios. 
                                You should try to exploit this vulnerability with newly implemented countermeasures and repeat the process to discover more possibilities of this attack.
                                <br><br>
                                Displaying the data part (line 141-158):
                                <table class="table table-striped table-hover table-sm table-bordered mt-2" style="width: auto;">
                                    <tbody>
                                        <tr><td><code style="color: #000000;">141</code></td><td style="white-space: break-spaces;"><code>// output the selected data to table</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">142</code></td><td style="white-space: break-spaces;"><code>if ($result->num_rows > 0) {</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">143</code></td><td style="white-space: break-spaces;"><code>    while($row = $result->fetch_assoc()) {</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">144</code></td><td style="white-space: break-spaces;"><code>        echo "&lt;tr&gt;";</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">145</code></td><td style="white-space: break-spaces;"><code>        echo "  &lt;td&gt;".$row["time"]."&lt;/td&gt;";</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">146</code></td><td style="white-space: break-spaces;"><code>        if ($row["attempt"] == "success") {</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">147</code></td><td style="white-space: break-spaces;"><code>            echo "  &lt;td class='table-success text-success'>&lt;strong&gt;".$row["attempt"]."&lt;/strong&gt;&lt;/td&gt;";</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">148</code></td><td style="white-space: break-spaces;"><code>        } else {</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">149</code></td><td style="white-space: break-spaces;"><code>            echo "  &lt;td class='table-danger text-danger'>&lt;strong&gt;".$row["attempt"]."&lt;/strong&gt;&lt;/td&gt;";</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">150</code></td><td style="white-space: break-spaces;"><code>        }</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">151</code></td><td style="white-space: break-spaces;"><code>        echo "  &lt;td&gt;".str_replace("&lt;s", "&amp;lt;s", $row["username"])."&lt;/td&gt;";</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">152</code></td><td style="white-space: break-spaces;"><code>        echo "  &lt;td&gt;".str_replace("&lt;s", "&amp;lt;s", $row["password"])."&lt;/td&gt;";</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">153</code></td><td style="white-space: break-spaces;"><code>        echo "&lt;/tr&gt;";</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">154</code></td><td style="white-space: break-spaces;"><code>    }</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">155</code></td><td style="white-space: break-spaces;"><code>} else {</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">156</code></td><td style="white-space: break-spaces;"><code>    echo "&lt;tr&gt;";</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">157</code></td><td style="white-space: break-spaces;"><code>    echo "&lt;/tr&gt;";</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">158</code></td><td style="white-space: break-spaces;"><code>}</code><br></td></tr>
                                    </tbody>
                                </table>
                                This code snippet is referring to the header of <code>Admin functions (Unavailable for users)</code> and the admin-only functions below it.
                                In the code snippet, you can see there are several <code>if ($role != "Admin")</code>. This is the condition to check if the logged in user has the role of <code>Admin</code> or not.
                                On line 102, we can see that if the logged in user is not an admin, the words <code>(Unavailable for users)</code> will be shown, vice versa. 
                                The same condition applies on line 104 as well, if the logged in user is not an admin, the <code>hidden</code> attribute will be added to the HTML element. 
                                However, adding the <code>hidden</code> attribute simply makes the element invisible, but cannot stop the users from interacting with it.
                            </p>
                            <br>
                            <h6>admin.php (Vulnerability #2)</h6>
                            <p>
                                This is the file handling the login process. Since the code on the login mechanism is the same for <code>admin.php</code> and <code>user.php</code>, you will need to change both of them. 
                                Cookies is used to remember the login session of the users, but the cookies contains insufficient details, leading to Vulnerability #2. 
                                Apart from the cookies branch, you can also look into the whole login implementation for more improvements.
                                <br><br>
                                login mechanism part (line 15-41):
                                <table class="table table-striped table-hover table-sm table-bordered mt-2" style="width: auto;">
                                    <tbody>
                                        <tr><td><code style="color: #000000;">15</code></td><td style="white-space: break-spaces;"><code>// verify login information</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">16</code></td><td style="white-space: break-spaces;"><code>$login = FALSE;</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">17</code></td><td style="white-space: break-spaces;"><code>$cookie_name = "A01_login_cookie";</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">18</code></td><td style="white-space: break-spaces;"><code>$role = "Admin";</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">19</code></td><td style="white-space: break-spaces;"><code>if (isset($_COOKIE[$cookie_name]) && $_COOKIE[$cookie_name] == "True") {</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">20</code></td><td style="white-space: break-spaces;"><code>    // check if the user has logged in previously from cookie</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">21</code></td><td style="white-space: break-spaces;"><code>    $login = TRUE;</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">22</code></td><td style="white-space: break-spaces;"><code>} else if ($_SERVER["REQUEST_METHOD"] == "POST") {</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">23</code></td><td style="white-space: break-spaces;"><code>    // check the login credential from database</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">24</code></td><td style="white-space: break-spaces;"><code>    $sql = $conn->prepare("SELECT * from users WHERE email=? AND studentNumber=? AND role=?;");</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">25</code></td><td style="white-space: break-spaces;"><code>    $sql->bind_param("sss", $_POST["username"], $_POST["password"], $role);</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">26</code></td><td style="white-space: break-spaces;"><code>    $sql->execute();</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">27</code></td><td style="white-space: break-spaces;"><code>    $result = $sql->get_result();</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">28</code></td><td style="white-space: break-spaces;"><code>    </code><br></td></tr>
                                        <tr><td><code style="color: #000000;">29</code></td><td style="white-space: break-spaces;"><code>    if ($result->num_rows == 1) {</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">30</code></td><td style="white-space: break-spaces;"><code>        $login = TRUE;</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">31</code></td><td style="white-space: break-spaces;"><code>    }</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">32</code></td><td style="white-space: break-spaces;"><code>    $sql->close();</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">33</code></td><td style="white-space: break-spaces;"><code>}</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">34</code></td><td style="white-space: break-spaces;"><code></code><br></td></tr>
                                        <tr><td><code style="color: #000000;">35</code></td><td style="white-space: break-spaces;"><code>if (!$login) {</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">36</code></td><td style="white-space: break-spaces;"><code>    // redirect to login failed page</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">37</code></td><td style="white-space: break-spaces;"><code>    header("location: loginFail.html");</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">38</code></td><td style="white-space: break-spaces;"><code>} else {</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">39</code></td><td style="white-space: break-spaces;"><code>    // set a login cookie to identify logged in user</code><br></td></tr>
                                        <tr><td><code style="color: #000000;">40</code></td><td style="white-space: break-spaces;"><code>    setcookie($cookie_name, "True", time() + (86400 * 365), "/"); </code><br></td></tr>
                                        <tr><td><code style="color: #000000;">41</code></td><td style="white-space: break-spaces;"><code>}</code><br></td></tr>
                                    </tbody>
                                </table>
                                This code snippet is referring to the whole login mechanism. 
                                The mechanism consists of two parts, it is validating the cookies from line 19 to line 21 and checking the credential through database from line 22 to line 32. 
                                The vulnerability exists in the first part, when the code is checking through the cookies. 
                                From line 17, we can see the cookies is stored in the name of <code>A01_login_cookie</code>. 
                                Also from line 19, the cookies is checked whether its value is <code>True</code> or not. If the cookies it true, then the user is authenticated. 
                                Then we can take a look at line 35 to line 41 to see how the cookies is set. 
                                We can know that as long as the user has logged in successfully once, the cookies will have the value <code>True</code>, regardless the role of the user.
                                As a result, a user can login to admin console page by typing the correct URL because of this weak authentication method.
                            </p>
                            <br>
                            <h5>Defense Explanation</h5>
                            <p>
                                After knowing what the code is doing and how does the vulnerabilities occur, we can start to know more about how to fix them. 
                                Please try to change the code base on your understanding at least once before directly looking into the solutions. 
                                You should retry the above exploitations after you have fixed the code to find out whether you have done it correctly or not.
                            </p>
                            <h6>Vulnerability #1</h6>
                            <p>
                                Since the vulnerability exists because of the weak <code>hidden</code> attribute, we need to find a better way to hide the admin-only functions from normal users. 
                                One of the ways to do it is by hiding the whole element from the browsers without using the <code>hidden</code> attribute. 
                                As we already know that <code>if ($role != "Admin")</code> is the condition checking the users' role, we can change something after the condition to completely hide the element.
                            </p>
                            <button class="btn btn-primary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#multiCollapseExample4" aria-expanded="false" aria-controls="multiCollapseExample4">Show solution #1</button>
                            <div class="row">
                                <div class="col">
                                    <div class="collapse multi-collapse" id="multiCollapseExample4">
                                        <div class="card card-body">
                                            <h5>Solution #1</h5>
                                            <p>
                                                dashboard.php (line 100-113):
                                                <table class="table table-striped table-hover table-sm table-bordered mt-2" style="width: auto;">
                                                    <tbody>
                                                        <tr><td><code style="color: #000000;">100</code></td><td style="white-space: break-spaces;"><code>&lt;!-- The below session only display to "Admin" role users --&gt;</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">101</code></td><td style="white-space: break-spaces;"><code>&lt;?php if ($role == "Admin") { ?&gt;</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">102</code></td><td style="white-space: break-spaces;"><code>    &lt;h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted text-uppercase"&gt;</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">103</code></td><td style="white-space: break-spaces;"><code>        &lt;span&gt;Admin functions&lt;/span&gt;</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">104</code></td><td style="white-space: break-spaces;"><code>    &lt;/h6&gt;</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">105</code></td><td style="white-space: break-spaces;"><code>    &lt;ul class="nav flex-column mb-2" id="admin_functions"&gt;</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">106</code></td><td style="white-space: break-spaces;"><code>        &lt;li class="nav-item"&gt;</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">107</code></td><td style="white-space: break-spaces;"><code>            &lt;a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#exampleModal"&gt;</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">108</code></td><td style="white-space: break-spaces;"><code>                &lt;svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke...</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">109</code></td><td style="white-space: break-spaces;"><code>                Reset admin password</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">110</code></td><td style="white-space: break-spaces;"><code>            &lt;/a&gt;</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">111</code></td><td style="white-space: break-spaces;"><code>        &lt;/li&gt;</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">112</code></td><td style="white-space: break-spaces;"><code>    &lt;/ul&gt;</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">113</code></td><td style="white-space: break-spaces;"><code>&lt;?php } ?&gt;</code><br></td></tr>
                                                    </tbody>
                                                </table>
                                                The PHP condition wraps the whole admin function and only display it when the role of the user is equal to <code>Admin</code>. 
                                                With this fix, the whole element has disappeared from the page, even if you inspect the page source again.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col"></div>
                            </div>
                            <br>
                            <h6>Vulnerability #2</h6>
                            <p>
                                Wonder why insert works?
                                As we know the weakness is the cookies validation part, we need to change the way of checking the cookies as well as assigning it. 
                                The problem with the current cookies is the lack of information about the logged in user. 
                                One of the intuitive approaches is to add some user information to the cookies, such as the roles, email or name, this can produce a more unique cookies such that admin users can be distinguished from normal users. 
                            </p>
                            <button class="btn btn-primary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#multiCollapseExample5" aria-expanded="false" aria-controls="multiCollapseExample5">Show solution #2</button>
                            <div class="row">
                                <div class="col">
                                    <div class="collapse multi-collapse" id="multiCollapseExample5">
                                        <div class="card card-body">
                                            <h5>Solution #2</h5>
                                            <p>
                                                admin.php (line 15-41):
                                                <table class="table table-striped table-hover table-sm table-bordered mt-2" style="width: auto;">
                                                    <tbody>
                                                        <tr><td><code style="color: #000000;">15</code></td><td style="white-space: break-spaces;"><code>// verify login information</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">16</code></td><td style="white-space: break-spaces;"><code>$login = FALSE;</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">17</code></td><td style="white-space: break-spaces;"><code>$cookie_name = "A01_login_cookie";</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">18</code></td><td style="white-space: break-spaces;"><code>$role = "Admin";</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">19</code></td><td style="white-space: break-spaces;"><code>if (isset($_COOKIE[$cookie_name]) && $_COOKIE[$cookie_name] == $role) {</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">20</code></td><td style="white-space: break-spaces;"><code>    // check if the user has logged in previously from cookie</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">21</code></td><td style="white-space: break-spaces;"><code>    $login = TRUE;</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">22</code></td><td style="white-space: break-spaces;"><code>} else if ($_SERVER["REQUEST_METHOD"] == "POST") {</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">23</code></td><td style="white-space: break-spaces;"><code>    // check the login credential from database</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">24</code></td><td style="white-space: break-spaces;"><code>    $sql = $conn->prepare("SELECT * from users WHERE email=? AND studentNumber=? AND role=?;");</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">25</code></td><td style="white-space: break-spaces;"><code>    $sql->bind_param("sss", $_POST["username"], $_POST["password"], $role);</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">26</code></td><td style="white-space: break-spaces;"><code>    $sql->execute();</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">27</code></td><td style="white-space: break-spaces;"><code>    $result = $sql->get_result();</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">28</code></td><td style="white-space: break-spaces;"><code>    </code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">29</code></td><td style="white-space: break-spaces;"><code>    if ($result->num_rows == 1) {</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">30</code></td><td style="white-space: break-spaces;"><code>        $login = TRUE;</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">31</code></td><td style="white-space: break-spaces;"><code>    }</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">32</code></td><td style="white-space: break-spaces;"><code>    $sql->close();</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">33</code></td><td style="white-space: break-spaces;"><code>}</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">34</code></td><td style="white-space: break-spaces;"><code></code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">35</code></td><td style="white-space: break-spaces;"><code>if (!$login) {</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">36</code></td><td style="white-space: break-spaces;"><code>    // redirect to login failed page</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">37</code></td><td style="white-space: break-spaces;"><code>    header("location: loginFail.html");</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">38</code></td><td style="white-space: break-spaces;"><code>} else {</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">39</code></td><td style="white-space: break-spaces;"><code>    // set a login cookie to identify logged in user</code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">40</code></td><td style="white-space: break-spaces;"><code>    setcookie($cookie_name, $role, time() + (86400 * 365), "/"); </code><br></td></tr>
                                                        <tr><td><code style="color: #000000;">41</code></td><td style="white-space: break-spaces;"><code>}</code><br></td></tr>                                                    </tbody>
                                                </table>
                                                The cookies is now assigned with the value of logged in user's role. 
                                                In this case, normal users cannot use their cookies to login the admin console page as the value of the cookies is different. 
                                                However, this is only a very weak fix because anyone can edit the value of the cookie and a malicious user can directly change the value to <code>Admin</code> for gaining the access. 
                                                A more proper fix is to use the username/email as the value of the cookies and check it against the database again. 
                                                You can try to implement it with the help of the code from line 24 to lin 31. 
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingFour">
                        <button class="accordion-button custom-explanation collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                            Resources & Further Readings
                        </button>
                    </h2>
                    <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour">
                        <div class="accordion-body text-start m-3">
                            <p>
                                If you are interested in this topic and eager to learn more, here are some good references for you:
                            </p>
                            <ul>
                                <li><a href="https://owasp.org/Top10/A01_2021-Broken_Access_Control/" target="_blank">A01 Broken Access Control - OWASP Top 10:2021</a></li>
                                <li><a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Global_attributes/hidden" target="_blank">hidden - HTML: HyperText Markup Language | MDN</a></li>
                                <li><a href="https://ico.org.uk/your-data-matters/online/cookies/#:~:text=A%20cookie%20is%20a%20small,people%20looking%20at%20a%20website." target="_blank">Cookies | ICO</a></li>
                                <li><a href="https://www.php.net/manual/en/control-structures.alternative-syntax.php" target="_blank">PHP: Alternative syntax for control structures - Manual</a></li>
                                <li><a href="https://www.php.net/manual/en/function.setcookie.php" target="_blank">PHP: setcookie - Manual</a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingFive">
                        <button class="accordion-button custom-challenge collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFive" aria-expanded="false" aria-controls="collapseFive">
                            Challenge
                        </button>
                    </h2>
                    <div id="collapseFive" class="accordion-collapse collapse" aria-labelledby="headingFive">
                        <div class="accordion-body text-start m-3">
                            This is a user console page, try to show the admin console, which list all the users information!
                            <br>
                            <a href="./challenge.php" target="_blank">Challenge</a>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </body>
</html>